<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <style>
        body {
            margin: 5px;
        }
        
        .container {}
        
        svg {
            display: block;
            margin: auto;
            border: 2px solid black;
            background-color: lightgray;
        }
    </style>
</head>

<body>

    <div class="container">
        <svg>
            <rect id="player"></rect>
        </svg>
    </div>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>

        //global vars
        var width = 800;
        var height = 600;
        var padding = 5;
        var playerId = 'player';
        var playerSize = 40;
        var getPlayerX = function(){return +player.attr('x');};
        var getEnemyX = function(){return +enemy.attr('x');};
        var getEnemyY = function(){return height/4;};
        var moveDelta = 2;
        var bulletRadius = 10;

        //svg
        //attaching listeners
        var svg = d3.select('svg')
            .attr('width', width)
            .attr('height', height)
            //move player
            .on('mousemove', function() {
                var point = d3.mouse(this);
                player.transition()
                    .duration(50)
                    .attr('x', point[0] - playerSize/2);
                    
            })
            //fire bullet
            .on('click', function() {
                svg.append('circle')
                        .attr('cx', getPlayerX() + playerSize/2)
                        .attr('cy', height - playerSize - padding - bulletRadius)
                        .attr('r', bulletRadius)
                        .attr('fill', 'red')
                    .transition()
                        .duration(700)
                        .attr('cy', -bulletRadius)
                        .ease(d3.easeLinear)
                        .remove();
            });

        //player
        var player = d3.select('#' + playerId)
            .attr('width', playerSize)
            .attr('height', playerSize)
            .attr('x', width/2 - playerSize/2)
            .attr('y', height - playerSize - padding)
            .style('fill', 'black')
        
        //enemy
        var enemy = svg.append('rect')
            .attr('id', 'enemy')
            .attr('width', playerSize)
            .attr('height', playerSize)
            .attr('x', width/2 - playerSize/2)
            .attr('y', height/4)
            .style('fill', 'green')


        function move() {
            enemy.attr('x', function() {
                var enemyX = getEnemyX();
                if (enemyX > width - playerSize || enemyX < 0){
                    moveDelta *= -1;
                }
                return enemyX += moveDelta;
            })
            .call(collide);

            window.requestAnimationFrame(move);
        }

        var score = 0;
        function collide() {
            var enemyX = getEnemyX();
            var enemyY = getEnemyY();
  
            d3.selectAll('circle')
                .each(function() {

                    var box = this.getBBox();
                    var bulletY = box.y;
                    var bulletX = box.x;
                    
                    if (bulletX + bulletRadius >= enemyX && bulletX - bulletRadius <= enemyX + playerSize) {
                        if(bulletY + bulletRadius <= enemyY + playerSize && bulletY + bulletRadius >= enemyY){
                            d3.select(this).remove();
                            console.log(++score);
                        }
                    }
                });
        }

        window.requestAnimationFrame(move);

    </script>
</body>